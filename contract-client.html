<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TimberNova — Client Contract Signing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    body { margin:0; background:#020617; color:#f9fafb; font-family:system-ui,sans-serif; display:flex; flex-direction:column; min-height:100vh; }
    main { padding:24px; max-width:900px; margin:0 auto; flex:1; }
    h1 { font-size:22px; margin-bottom:8px; }
    .sub { color:#9ca3af; font-size:14px; margin-bottom:20px; }
    .contract-doc { border-radius:16px; border:1px solid rgba(148,163,184,0.3); background:rgba(15,23,42,0.95); padding:20px; font-size:14px; line-height:1.6; }
    .section-title { font-weight:600; margin-top:12px; margin-bottom:4px; }
    .sig-blocks { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:20px; }
    @media (max-width:700px){ .sig-blocks{grid-template-columns:1fr;} }
    .sig-box { border-radius:12px; border:1px solid rgba(148,163,184,0.4); padding:10px; }
    .sig-line { margin-top:18px; border-top:1px solid rgba(148,163,184,0.5); padding-top:6px; font-size:13px; }
    .sig-name { font-family:"Pacifico","Segoe Script","Brush Script MT",cursive; font-size:20px; color:#bbf7d0; }
    .sig-input { width:100%; border-radius:10px; border:1px solid rgba(148,163,184,0.6); background:rgba(15,23,42,0.9); color:#e5e7eb; padding:6px 8px; font-size:13px; margin-top:6px; }
    .actions { margin-top:16px; display:flex; justify-content:space-between; align-items:center; }
    .actions button { border:none; border-radius:999px; padding:8px 14px; font-size:13px; cursor:pointer; }
    .btn-primary { background:linear-gradient(120deg,#22c55e,#4ade80); color:#022c22; }
    .btn-ghost { background:rgba(15,23,42,0.9); color:#e5e7eb; border:1px solid rgba(148,163,184,0.5); }
    .status { font-size:12px; color:#9ca3af; margin-top:6px; }
  </style>
</head>
<body>

  <main>
    <h1>Contract for Tree Work</h1>
    <div class="sub" id="subText"></div>

    <div class="contract-doc" id="contractDoc"></div>

    <div class="actions" id="actionRow">
      <button class="btn-primary" id="signBtn">Sign contract</button>
      <button class="btn-ghost" id="sendBackBtn" style="display:none;">Send back</button>
    </div>

    <div class="status" id="statusMsg"></div>
  </main>

  <script>
    const params = new URLSearchParams(window.location.search);
    const contractId = params.get("id");

    function loadContracts() {
      try { return JSON.parse(localStorage.getItem("timberNovaContracts") || "[]"); }
      catch { return []; }
    }
    function saveContracts(contracts) {
      localStorage.setItem("timberNovaContracts", JSON.stringify(contracts));
    }

    const contracts = loadContracts();
    const contract = contracts.find(c => c.id === contractId);

    const subText = document.getElementById("subText");
    const docEl = document.getElementById("contractDoc");
    const signBtn = document.getElementById("signBtn");
    const sendBackBtn = document.getElementById("sendBackBtn");
    const statusMsg = document.getElementById("statusMsg");

    if (!contract) {
      docEl.innerHTML = "<div style='color:#fecaca;'>Contract not found.</div>";
      signBtn.style.display = "none";
    } else {
      const created = new Date(contract.createdAt).toLocaleDateString();
      const due = contract.dueDate ? new Date(contract.dueDate).toLocaleDateString() : "N/A";

      subText.textContent = `${contract.clientName} • ${contract.jobAddress} • Created ${created}`;

      docEl.innerHTML = `
        <div><strong>Client:</strong> ${contract.clientName} (${contract.clientEmail})</div>
        <div><strong>Job address:</strong> ${contract.jobAddress}</div>
        <div><strong>Price:</strong> $${contract.price}</div>
        <div><strong>Job completion date:</strong> ${due}</div>

        <div class="section-title">Scope of work</div>
        <div>${contract.jobDescription.replace(/\n/g,"<br/>")}</div>

        <div class="section-title">Terms</div>
        <div>${contract.terms.replace(/\n/g,"<br/>")}</div>

        <div class="section-title">Signatures</div>
        <div class="sig-blocks">
          <div class="sig-box">
            <div><strong>TimberNova representative</strong></div>
            <div class="sig-line">
              <div class="sig-name">${contract.adminSignature || ""}</div>
              <div style="font-size:11px;color:#9ca3af;">Signed by TimberNova</div>
            </div>
          </div>
          <div class="sig-box">
            <div><strong>Client</strong></div>
            <div class="sig-line">
              <div class="sig-name" id="clientSigName">${contract.clientSignature || ""}</div>
              <div style="font-size:11px;color:#9ca3af;">Signed by client</div>
            </div>
          </div>
        </div>
      `;

      if (contract.status !== "Sent") {
        signBtn.style.display = "none";
        statusMsg.textContent = "This contract is not ready for client signing.";
      }

      if (contract.clientSignature) {
        signBtn.style.display = "none";
        sendBackBtn.style.display = "inline-block";
      }
    }

    signBtn.onclick = () => {
      const name = prompt("Type your full name to sign:");
      if (!name) return;

      contract.clientSignature = name;
      contract.status = "ClientSigned";
      saveContracts(contracts);

      document.getElementById("clientSigName").textContent = name;
      signBtn.style.display = "none";
      sendBackBtn.style.display = "inline-block";
      statusMsg.textContent = "Signature captured.";
    };

    sendBackBtn.onclick = () => {
      const subject = encodeURIComponent("Signed contract");
      const body = encodeURIComponent("Hello, I have signed the contract. Thank you.");
      window.location.href = `mailto:${contract.clientEmail}?subject=${subject}&body=${body}`;
      statusMsg.textContent = "Contract returned.";
    };
  </script>

</body>
</html>
